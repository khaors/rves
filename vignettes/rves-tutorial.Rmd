---
title: "RVES Tutorial: Vertical Electrical Sounding interpretation using R"
author: "Oscar Garcia-Cabrejo"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RVES tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(rves)
```

# Introduction

Importance of subsurface investigations. Specially for groundwater.

The Vertical Electrical Sounding (VES) is one of the oldest resistivity methods and its main advantages include: 

- low cost due to its minimal requirements for equipment and personal.
- large investigation depth as required in some specific problems such as groundwater exploration.

This method is based on the measurements of the electrical apparent resistivity of the geological medium when the distance between the electrical source and the measurement nodes is increased. From this information the true resistivities and thicknesses of the geological model are estimated.

# Methodology

## VES: Basic Concepts
Let $A,B$ be the current electrodes (positive and negative respectively) located on the ground surface and $M,N$ are the sensors used to measure the potential. The apparent resistivity of an Earth material is defined as:

$$
\rho_{app,k} = k \frac{U_{MN}}{I_{AB}}
$$
where $k$ is the so called geometric factor of the electrode array, $U_{MN}$ is the voltage between the electrodes $M$ and $N$ and $I_{AB}$ is the electric current applied between the measurement electrodes $A$ and $B$. 

The geometric factor of the array is defined as:
$$
k=\frac{2 \pi}{\frac{1}{r_{AM}} - \frac{1}{r_{BM}} - \frac{1}{r_{AN}} + \frac{1}{r_{BN}} }
$$
where $r$ is the distance between the electrodes.

The values of the apparent resistivity $\rho_{app,k}$ change as the electrode separation $AB/2$ is increased.  

## Layered Earth

$$
U(x)=\frac{I \rho_{1}}{2 \pi} \frac{1}{x} \left( 1 + 2x \int_{0}^{+\infty} K(\lambda) J_{0}(\lambda x)d\lambda \right)
$$
where $\rho_{1}$ is the resistivity of the first layer, $J_{0}$ is the Bessel function of order zero , and $K(\lambda)$ is a function that depends on $\lambda$ and the resisitivities and thicknesses of all layers and the resistivity of the substratum. The integral in the previous equation can be interpreted as potential disturbance due to the layered structure of the Earth and this must be numerically evaluated.   


## Parameter Estimation

# Examples

## VES 1


```{r load_library,echo=TRUE}
library(rves)
```

```{r load_data,echo=TRUE}
data("ves_data1")
```

```{r define_ves,echo=TRUE}
ab2 <- ves_data1$ab2
apprho <- ves_data1$apprho
sev1a <- ves(id= "Sounding 1", ab2 = ab2, apprho = apprho)
```

```{r plot_sev1a, fig.height=4,fig.width=6,fig.align='center'}
p1 <- plot(sev1a)
```

```{r initial_sol, echo= TRUE}
rho <- c(40,70,30, 20)
thick <- c(2,10,50,500)
sev1a$rhopar <- rho
sev1a$thickpar <- thick
sev1a$interpreted <- TRUE
```

```{r plot_sev1a1, fig.height=4, fig.width=6,fig.align='center'}
p2 <- plot(sev1a)
```

```{r calculate_appres,echo=TRUE}
res <- apparent_resistivities(rho, thick, filt=filt$V1, ab2)
print(res$appres)
```

```{r calculate_error,echo=TRUE}
rerr <- 100*abs(res$appres-apprho)/res$appres
print(rerr)
print(mean(rerr))
```

```{r calculate_rho_thick_nls, echo=TRUE}
par0 <- c(rho, thick)
res.nls <- calibrate_nls(sev1a, par0, iterations = 10, ireport = 5)
```

```{r assign_results_nls,echo=TRUE}
sev1a$rhopar <- res.nls$rho
sev1a$thickpar <- res.nls$thickness
sev1a$interpreted <- TRUE
```

```{r plot_earth_model_nls,fig.height=4, fig.width=6,fig.align='center'}
p1 <- plot(sev1a, main = "Nonlinear Least Squares")
```

```{r calibrate_lbfgs, echo=TRUE}
res.lbfgs <- calibrate(sev1a, opt.method = "L-BFGS-B", obj.fn = "rss", 
                       par0 = par0, lower = c(rep(5,4), rep(5,4)), 
                       upper = c(rep(100,4),rep(501,4)))
```

```{r assign_results_lbfgsb, echo=TRUE}
sev1a$rhopar <- res.lbfgs$rho
sev1a$thickpar <- res.lbfgs$thickness
sev1a$interpreted <- TRUE
```

```{r plot_earth_model_lbfgsb,fig.height=4, fig.width=6,fig.align='center'}
p2 <- plot(sev1a, main = "L-BFGS-B")
```



